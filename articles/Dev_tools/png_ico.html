<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PNG → ICO Converter</title>
</head>
<body class="article-page">
<div>
<h1>PNG → ICO Converter</h1>

<label for="pngfile">Select PNG file:</label>
<input type="file" id="pngfile" accept="image/png">

<label for="icoSize">Select ICO size:</label>
<select id="icoSize">
  <option value="32">32×32</option>
  <option value="64">64×64</option>
  <option value="128">128×128</option>
  <option value="256">256×256</option>
</select>

<button id="convertBtn">Convert to ICO</button>
<a id="downloadLink" style="display:none;">Download ICO</a>
</div>

<script>
function writeUInt16LE(view, offset, value) {
    view[offset] = value & 0xff;
    view[offset+1] = (value >> 8) & 0xff;
}

function writeUInt32LE(view, offset, value) {
    view[offset] = value & 0xff;
    view[offset+1] = (value >> 8) & 0xff;
    view[offset+2] = (value >> 16) & 0xff;
    view[offset+3] = (value >> 24) & 0xff;
}

function rgbaToDIB(rgba, width, height) {
    const bmp = new Uint8Array(width * height * 4);
    for (let y=0; y<height; y++) {
        for (let x=0; x<width; x++) {
            const i = ((height-1-y)*width + x)*4;
            const j = (y*width + x)*4;
            bmp[j] = rgba[i+2]; // B
            bmp[j+1] = rgba[i+1]; // G
            bmp[j+2] = rgba[i]; // R
            bmp[j+3] = rgba[i+3]; // A
        }
    }
    return bmp;
}

document.getElementById('convertBtn').addEventListener('click', () => {
    const fileInput = document.getElementById('pngfile');
    const size = parseInt(document.getElementById('icoSize').value);
    if (!fileInput.files[0]) { alert("Please select a PNG file."); return; }

    const img = new Image();
    img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, size, size);
        const imageData = ctx.getImageData(0,0,size,size);

        const dibData = rgbaToDIB(imageData.data, size, size);
        const dibHeaderSize = 40;
        const dibSize = dibHeaderSize + dibData.length;

        const icoBuffer = new ArrayBuffer(6 + 16 + dibSize);
        const view = new Uint8Array(icoBuffer);

        // ICONDIR
        writeUInt16LE(view,0,0);
        writeUInt16LE(view,2,1);
        writeUInt16LE(view,4,1);

        // ICONDIRENTRY
        view[6] = size >= 256 ? 0 : size;
        view[7] = size >= 256 ? 0 : size;
        view[8] = 0;
        view[9] = 0;
        writeUInt16LE(view,10,1);
        writeUInt16LE(view,12,32);
        writeUInt32LE(view,14,dibSize);
        writeUInt32LE(view,18,6+16);

        // BITMAPINFOHEADER
        writeUInt32LE(view,22,dibHeaderSize);
        writeUInt32LE(view,26,size);
        writeUInt32LE(view,30,size*2);
        writeUInt16LE(view,34,1);
        writeUInt16LE(view,36,32);
        writeUInt32LE(view,38,0);
        writeUInt32LE(view,42,dibData.length);
        writeUInt32LE(view,46,0);
        writeUInt32LE(view,50,0);
        writeUInt32LE(view,54,0);
        writeUInt32LE(view,58,0);

        view.set(dibData, 62);

        const blob = new Blob([icoBuffer], {type:'image/x-icon'});
        const url = URL.createObjectURL(blob);

        const link = document.getElementById('downloadLink');
        link.href = url;
        link.download = 'icon.ico';
        link.style.display = 'inline-block';
        link.textContent = 'Download ICO';
    };
    img.src = URL.createObjectURL(fileInput.files[0]);
});
</script>
</body>
</html>
