<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Music Media Player</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div class="article-page">
    <h1>Music Media Player (ALFA)</h1>
    
    <div class="player-container">
      <div class="player">
        <div class="left">
          <div>
            <div class="title">Odtwarzacz MP3</div>
            <div class="subtitle">Wrzuƒá plik audio lub upu≈õƒá go na pole. Lokalnie, bez wysy≈Çania.</div>
          </div>

          <label id="dropzone" class="dropzone" for="file-input">
            <div class="dropzone-icon">üéµ</div>
            <div>Kliknij lub upu≈õƒá plik tutaj</div>
            <div style="font-size:12px; color:var(--muted)">Obs≈Çugiwane formaty: MP3, WAV, OGG, FLAC, AAC, M4A</div>
          </label>
          <input id="file-input" type="file" accept="audio/*" style="display:none" multiple />

          <div class="controls">
            <button id="prevBtn" class="btn" title="Poprzedni">
              <span>‚èÆ</span>
              <span class="btn-text">Poprz.</span>
            </button>
            <button id="playBtn" class="btn accent" title="Odtwarzaj">
              <span>‚ñ∂Ô∏è</span>
              <span class="btn-text">Play</span>
            </button>
            <button id="pauseBtn" class="btn" title="Pauza">
              <span>‚è∏</span>
              <span class="btn-text">Pauza</span>
            </button>
            <button id="stopBtn" class="btn" title="Stop">
              <span>‚èπ</span>
              <span class="btn-text">Stop</span>
            </button>
            <button id="nextBtn" class="btn" title="Nastƒôpny">
              <span>‚è≠</span>
              <span class="btn-text">Nast.</span>
            </button>
            <button id="loopBtn" class="btn" title="Zapƒôtlaj">
              <span>üîÅ</span>
              <span class="btn-text">Loop</span>
            </button>
            <button id="shuffleBtn" class="btn" title="Losuj">
              <span>üîÄ</span>
              <span class="btn-text">Shuffle</span>
            </button>
          </div>

          <div class="progress">
            <input id="seek" type="range" min="0" max="100" value="0">
            <div class="meta">
              <div id="time">00:00 / 00:00</div>
              <div id="filename">Brak pliku</div>
            </div>
          </div>

          <div class="speed-box">
            <label>Prƒôdko≈õƒá odtwarzania: <span id="speedVal">1.0x</span></label>
            <input id="speed" type="range" min="0.5" max="2" step="0.1" value="1">
          </div>

          <div class="eq-container">
            <div class="eq-title">Zaawansowany Equalizer</div>
            
            <div class="eq-presets">
              <button class="btn eq-preset-btn" data-preset="flat">P≈Çaski</button>
              <button class="btn eq-preset-btn" data-preset="bass">Bass Boost</button>
              <button class="btn eq-preset-btn" data-preset="treble">Treble Boost</button>
              <button class="btn eq-preset-btn" data-preset="vshape">V-Shape</button>
              <button class="btn eq-preset-btn" data-preset="loudness">Loudness</button>
              <button class="btn eq-preset-btn" data-preset="reset">Reset</button>
            </div>
            
            <div class="eq-sliders">
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="32" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">32Hz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="64" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">64Hz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="125" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">125Hz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="250" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">250Hz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="500" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">500Hz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="1000" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">1kHz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="2000" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">2kHz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="4000" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">4kHz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="8000" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">8kHz</div>
              </div>
              <div class="eq-slider">
                <input type="range" min="-24" max="24" value="0" data-freq="16000" step="1">
                <div class="eq-slider-labels">
                  <div class="eq-slider-label">+24</div>
                  <div class="eq-slider-label">+12</div>
                  <div class="eq-slider-label zero">0</div>
                  <div class="eq-slider-label">-12</div>
                  <div class="eq-slider-label">-24</div>
                </div>
                <div class="eq-slider-freq">16kHz</div>
              </div>
            </div>
          </div>

          <footer>
            Last update 19.11.2025
          </footer>
        </div>

        <div class="right">
          <div class="visualizer">
            <canvas id="vis"></canvas>
          </div>

          <div class="vu-meter">
            <div class="vu-meter-title">VU Meter 5.1</div>
            <div class="vu-channels">
              <div class="vu-channel">
                <div class="vu-channel-label">L</div>
                <div class="vu-bar-container">
                  <div class="vu-bar" id="vuL"></div>
                </div>
              </div>
              <div class="vu-channel">
                <div class="vu-channel-label">R</div>
                <div class="vu-bar-container">
                  <div class="vu-bar" id="vuR"></div>
                </div>
              </div>
              <div class="vu-channel">
                <div class="vu-channel-label">C</div>
                <div class="vu-bar-container">
                  <div class="vu-bar" id="vuC"></div>
                </div>
              </div>
              <div class="vu-channel">
                <div class="vu-channel-label">LFE</div>
                <div class="vu-bar-container">
                  <div class="vu-bar" id="vuLFE"></div>
                </div>
              </div>
              <div class="vu-channel">
                <div class="vu-channel-label">SL</div>
                <div class="vu-bar-container">
                  <div class="vu-bar" id="vuSL"></div>
                </div>
              </div>
              <div class="vu-channel">
                <div class="vu-channel-label">SR</div>
                <div class="vu-bar-container">
                  <div class="vu-bar" id="vuSR"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="playlist-container">
            <div class="playlist-header">
              <div class="playlist-title">Lista odtwarzania</div>
              <button id="clearList" class="btn">Wyczy≈õƒá listƒô</button>
            </div>
            <div id="list" class="filelist"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Audio player elements
    const fileInput = document.getElementById('file-input');
    const dropzone = document.getElementById('dropzone');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const loopBtn = document.getElementById('loopBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const seek = document.getElementById('seek');
    const time = document.getElementById('time');
    const filename = document.getElementById('filename');
    const speed = document.getElementById('speed');
    const speedVal = document.getElementById('speedVal');
    const listEl = document.getElementById('list');
    const clearBtn = document.getElementById('clearList');
    const eqSliders = document.querySelectorAll('.eq-sliders input');
    const eqPresets = document.querySelectorAll('.eq-preset-btn');

    // VU Meter elements
    const vuBars = {
      L: document.getElementById('vuL'),
      R: document.getElementById('vuR'),
      C: document.getElementById('vuC'),
      LFE: document.getElementById('vuLFE'),
      SL: document.getElementById('vuSL'),
      SR: document.getElementById('vuSR')
    };

    // Audio setup
    let audio = new Audio();
    audio.preload = 'auto';
    let audioURL = null;
    let playlist = [];
    let currentIndex = 0;
    let isPlaying = false;
    
    // Audio context and equalizer setup
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const AC = new AudioCtx();
    const analyser = AC.createAnalyser();
    analyser.fftSize = 256;
    
    // Create equalizer nodes
    const filters = [];
    const frequencies = [32, 64, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
    
    let sourceNode = null;

    // VU Meter analyzer
    const vuAnalyser = AC.createAnalyser();
    vuAnalyser.fftSize = 2048;
    const vuDataArray = new Uint8Array(vuAnalyser.frequencyBinCount);

    // Inicjalizacja filtr√≥w
    function initializeFilters() {
      frequencies.forEach(freq => {
        const filter = AC.createBiquadFilter();
        filter.type = 'peaking';
        filter.frequency.value = freq;
        filter.Q.value = 1;
        filter.gain.value = 0;
        filters.push(filter);
      });
    }

    // Po≈ÇƒÖczenie wƒôz≈Ç√≥w audio
    function connectAudioNodes() {
      if (sourceNode) {
        sourceNode.disconnect();
      }
      
      sourceNode = AC.createMediaElementSource(audio);
      let currentNode = sourceNode;
      
      filters.forEach(filter => {
        currentNode.connect(filter);
        currentNode = filter;
      });
      
      currentNode.connect(analyser);
      currentNode.connect(vuAnalyser);
      analyser.connect(AC.destination);
      vuAnalyser.connect(AC.destination);
    }

    // Inicjalizacja przy starcie
    initializeFilters();

    // Equalizer functionality
    eqSliders.forEach((slider, index) => {
      slider.value = 0;
      
      slider.addEventListener('input', () => {
        const gain = parseFloat(slider.value);
        if (filters[index]) {
          filters[index].gain.value = gain;
        }
      });
    });

    // Preset values
    const presetValues = {
      flat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      bass: [16, 12, 8, 4, 0, -2, -4, -6, -4, 0],
      treble: [-6, -4, -2, 0, 2, 6, 10, 14, 16, 18],
      vshape: [12, 8, 4, 0, -2, -4, 0, 6, 10, 14],
      loudness: [8, 6, 4, 2, 0, 2, 4, 6, 8, 10]
    };

    eqPresets.forEach(preset => {
      preset.addEventListener('click', () => {
        const presetType = preset.dataset.preset;
        
        if (presetType === 'reset') {
          eqSliders.forEach((slider, index) => {
            slider.value = 0;
            if (filters[index]) {
              filters[index].gain.value = 0;
            }
          });
        } else if (presetValues[presetType]) {
          presetValues[presetType].forEach((value, index) => {
            if (eqSliders[index] && filters[index]) {
              eqSliders[index].value = value;
              filters[index].gain.value = value;
            }
          });
        }
      });
    });

    // VU Meter update function
    function updateVUMeter() {
      if (!isPlaying) return;
      
      vuAnalyser.getByteFrequencyData(vuDataArray);
      
      const rms = Math.sqrt(vuDataArray.reduce((sum, value) => sum + value * value, 0) / vuDataArray.length);
      const db = 20 * Math.log10(rms / 255);
      
      const normalizedDb = Math.max(-48, Math.min(5, db));
      const height = ((normalizedDb + 48) / 53) * 100;
      
      Object.values(vuBars).forEach((bar, index) => {
        const variation = 0.9 + (Math.random() * 0.2);
        const channelHeight = Math.max(2, height * variation);
        bar.style.height = channelHeight + '%';
      });
      
      requestAnimationFrame(updateVUMeter);
    }

    // Player controls
    shuffleBtn.addEventListener('click', () => {
      shuffleBtn.classList.toggle('active');
    });

    loopBtn.addEventListener('click', () => {
      audio.loop = !audio.loop;
      loopBtn.classList.toggle('active');
    });

    speed.addEventListener('input', () => {
      audio.playbackRate = parseFloat(speed.value);
      speedVal.textContent = speed.value + "x";
    });

    function loadFile(file) {
      audio.pause();
      isPlaying = false;
      playBtn.textContent = 'Play';
      
      if (audioURL) {
        URL.revokeObjectURL(audioURL);
      }
      
      audioURL = URL.createObjectURL(file);
      audio.src = audioURL;
      filename.textContent = file.name;

      // Reset event listeners
      audio.onloadedmetadata = null;
      audio.ontimeupdate = null;
      audio.onplay = null;
      audio.onpause = null;
      audio.onended = null;
      audio.onerror = null;

      connectAudioNodes();

      audio.onloadedmetadata = () => {
        if (!isNaN(audio.duration)) {
          seek.max = Math.floor(audio.duration);
          time.textContent = `00:00 / ${fmt(audio.duration)}`;
        }
        updateFileList();
      };

      audio.ontimeupdate = () => {
        if (!isNaN(audio.duration)) {
          seek.value = Math.floor(audio.currentTime);
          time.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`;
        }
      };
      
      audio.onplay = () => {
        isPlaying = true;
        playBtn.textContent = 'Pauza';
        if (AC.state === 'suspended') {
          AC.resume();
        }
        updateVUMeter();
      };
      
      audio.onpause = () => {
        isPlaying = false;
        playBtn.textContent = 'Play';
        Object.values(vuBars).forEach(bar => {
          bar.style.height = '0%';
        });
      };
      
      audio.onended = () => {
        isPlaying = false;
        playBtn.textContent = 'Play';
        Object.values(vuBars).forEach(bar => {
          bar.style.height = '0%';
        });
        playNext();
      };

      audio.onerror = (e) => {
        console.error('Audio error:', e);
        isPlaying = false;
        playBtn.textContent = 'Play';
      };
    }

    function fmt(secs) {
      if (isNaN(secs)) return "00:00";
      const m = Math.floor(secs/60).toString().padStart(2,'0');
      const s = Math.floor(secs%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    // File type icon mapping
    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        'mp3': 'üéµ',
        'wav': 'üéº',
        'ogg': 'üéß',
        'flac': 'üé∂',
        'aac': 'üîä',
        'm4a': 'üìª'
      };
      return {
        icon: icons[ext] || 'üìÑ',
        className: `file-type-${ext} file-type-default`
      };
    }

    function addToList(file) {
      const existingIndex = playlist.findIndex(f => f.name === file.name && f.size === file.size);
      if (existingIndex === -1) {
        playlist.push(file);
        updateFileList();
      }
    }

    function updateFileList() {
      listEl.innerHTML = '';
      playlist.forEach((file, index) => {
        const fileIcon = getFileIcon(file.name);
        const item = document.createElement('div');
        item.className = `file-item ${index === currentIndex ? 'active' : ''}`;
        item.innerHTML = `
          <div class="file-info">
            <div class="file-icon ${fileIcon.className}">${fileIcon.icon}</div>
            <div class="file-details">
              <div class="file-name">${file.name}</div>
              <div class="file-meta">${(file.size / (1024 * 1024)).toFixed(2)} MB ‚Ä¢ ${file.type || 'audio'}</div>
            </div>
          </div>
          <div class="file-controls">
            <button class='btn' data-action="play" title="Odtwarzaj">‚ñ∂Ô∏è</button>
            <button class='btn' data-action="remove" title="Usu≈Ñ">üóëÔ∏è</button>
          </div>
        `;
        
        item.querySelector('[data-action="play"]').onclick = () => playIndex(index);
        item.querySelector('[data-action="remove"]').onclick = (e) => {
          e.stopPropagation();
          removeFromPlaylist(index);
        };
        
        listEl.appendChild(item);
      });
    }

    function removeFromPlaylist(index) {
      if (index === currentIndex) {
        audio.pause();
        audio.currentTime = 0;
        isPlaying = false;
        playBtn.textContent = 'Play';
      }
      
      playlist.splice(index, 1);
      
      if (currentIndex >= index && currentIndex > 0) {
        currentIndex--;
      }
      
      if (playlist.length === 0) {
        if (audioURL) URL.revokeObjectURL(audioURL);
        audio.src = '';
        filename.textContent = 'Brak pliku';
        time.textContent = '00:00 / 00:00';
        seek.value = 0;
        currentIndex = 0;
      } else if (currentIndex < playlist.length) {
        loadFile(playlist[currentIndex]);
      }
      updateFileList();
    }

    function playIndex(i) {
      if (i >= 0 && i < playlist.length) {
        currentIndex = i;
        loadFile(playlist[i]);
        audio.play().catch(e => {
          console.error('Play error:', e);
        });
        updateFileList();
      }
    }

    function playNext() {
      if (playlist.length === 0) return;
      
      if (shuffleBtn.classList.contains('active')) {
        let newIndex;
        do {
          newIndex = Math.floor(Math.random() * playlist.length);
        } while (playlist.length > 1 && newIndex === currentIndex);
        playIndex(newIndex);
      } else {
        const next = (currentIndex + 1) % playlist.length;
        if (next === 0 && !audio.loop) return;
        playIndex(next);
      }
    }

    function playPrev() {
      if (playlist.length === 0) return;
      const prev = (currentIndex - 1 + playlist.length) % playlist.length;
      playIndex(prev);
    }

    // Event listeners
    seek.addEventListener('input', () => {
      if (!isNaN(audio.duration)) {
        audio.currentTime = parseFloat(seek.value);
      }
    });

    playBtn.addEventListener('click', () => {
      if (!audio.src) {
        if (playlist.length > 0) {
          playIndex(currentIndex);
        }
        return;
      }
      
      if (audio.paused) { 
        audio.play().catch(e => {
          console.error('Play error:', e);
        });
      } else { 
        audio.pause(); 
      }
    });

    pauseBtn.addEventListener('click', () => {
      audio.pause();
    });

    stopBtn.addEventListener('click', () => {
      audio.pause(); 
      audio.currentTime = 0; 
      isPlaying = false;
      playBtn.textContent = 'Play';
    });

    prevBtn.addEventListener('click', playPrev);
    nextBtn.addEventListener('click', () => playNext());

    clearBtn.addEventListener('click', () => {
      audio.pause();
      audio.currentTime = 0;
      isPlaying = false;
      playBtn.textContent = 'Play';
      
      listEl.innerHTML = '';
      playlist = [];
      currentIndex = 0;
      if (audioURL) URL.revokeObjectURL(audioURL);
      audio.src = '';
      filename.textContent = 'Brak pliku';
      time.textContent = '00:00 / 00:00';
      seek.value = 0;
    });

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      files.forEach(file => {
        if (file.type.startsWith('audio/')) {
          addToList(file);
        }
      });
      if (files.length > 0 && playlist.length === files.length) {
        playIndex(0);
      }
    });

    // Drag & drop
    ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e => { 
      e.preventDefault(); 
      dropzone.classList.add('drag'); 
    }));
    
    ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e => { 
      e.preventDefault(); 
      dropzone.classList.remove('drag'); 
    }));
    
    dropzone.addEventListener('drop', e => {
      const files = Array.from(e.dataTransfer.files);
      files.forEach(file => {
        if (file.type.startsWith('audio/')) {
          addToList(file);
        }
      });
      if (files.length > 0 && playlist.length === files.length) {
        playIndex(0);
      }
    });

    // Visualizer
    const canvas = document.getElementById('vis');
    const ctx = canvas.getContext('2d');
    const buffer = new Uint8Array(analyser.frequencyBinCount);

    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
    }

    function draw() {
      requestAnimationFrame(draw);
      
      analyser.getByteFrequencyData(buffer);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!isPlaying) return;
      
      const barWidth = canvas.width / buffer.length;
      for(let i = 0; i < buffer.length; i++) {
        const barHeight = (buffer[i] / 255) * canvas.height;
        const hue = 140 - (barHeight / canvas.height) * 40;
        
        ctx.fillStyle = `hsl(${hue}, 70%, 60%)`;
        ctx.fillRect(i * barWidth, canvas.height - barHeight, barWidth - 1, barHeight);
      }
    }

    // Initialize
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    draw();
  </script>
</body>
</html>
