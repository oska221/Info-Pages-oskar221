<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Odtwarzacz MP3</title>
  <style>
    :root {
      /* Dark theme variables only */
      --bg: #0b0d10;
      --panel: #0f1216;
      --text: #e6eef3;
      --muted: #9aa3ad;
      --accent: #6ee7b7;
      --danger: #ff6b6b;
      --glass: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.04);
      --radius: 14px;
      font-family: Inter, system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    body {
      display: flex;
      justify-content: center;
      padding: 25px 16px;
      min-height: 100vh;
    }

    /* Mobile Layout - Domy≈õlny */
    .player {
      width: 100%;
      max-width: 100%;
      background: var(--panel);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin: auto 0;
    }

    /* Tablet Layout */
    @media (min-width: 768px) {
      body {
        padding: 25px 20px;
      }
      
      .player {
        padding: 24px;
        gap: 24px;
        max-width: 90%;
      }
    }

    /* Desktop Layout */
    @media (min-width: 1024px) {
      body {
        padding: 25px;
      }
      
      .player {
        max-width: 1200px;
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 32px;
        padding: 32px;
      }

      .left {
        padding: 0;
      }

      .right {
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
    }

    /* Common Styles */
    .left, .right {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    .title {
      font-size: clamp(20px, 4vw, 28px);
      font-weight: 700;
      margin: 0;
      color: var(--text);
      line-height: 1.2;
    }

    .subtitle {
      color: var(--muted);
      font-size: clamp(12px, 2.5vw, 14px);
      margin: 4px 0 0 0;
      line-height: 1.4;
    }

    .dropzone {
      border-radius: 12px;
      padding: clamp(16px, 4vw, 24px);
      background: var(--glass);
      border: 2px dashed var(--border);
      min-height: clamp(120px, 20vw, 140px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      cursor: pointer;
      gap: 8px;
    }

    .dropzone.drag {
      background: rgba(110, 231, 183, 0.1);
      border-color: var(--accent);
    }

    .dropzone-icon {
      font-size: clamp(24px, 6vw, 32px);
      margin-bottom: 8px;
    }

    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 8px;
    }

    @media (min-width: 480px) {
      .controls {
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
      }
    }

    .btn {
      background: transparent;
      border: 1px solid var(--border);
      padding: clamp(10px, 2vw, 12px) clamp(8px, 1.5vw, 16px);
      border-radius: 10px;
      cursor: pointer;
      color: var(--text);
      font-size: clamp(11px, 2.5vw, 14px);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 44px;
      white-space: nowrap;
    }

    .btn.accent {
      background: rgba(110, 231, 183, 0.15);
      border-color: var(--accent);
      color: var(--accent);
      font-weight: 600;
    }

    .btn:hover {
      background: var(--glass);
    }

    .btn.active {
      border-color: var(--accent);
      background: rgba(110, 231, 183, 0.15);
    }

    /* Progress */
    .progress {
      margin-top: 16px;
      padding: 0 4px;
    }

    input[type="range"] {
      appearance: none;
      width: 100%;
      height: 6px;
      background: var(--glass);
      border-radius: 6px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid var(--panel);
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid var(--panel);
    }

    .meta {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      color: var(--muted);
      font-size: clamp(11px, 2.5vw, 13px);
      padding: 0 4px;
    }

    /* Visualizer */
    .visualizer {
      height: clamp(140px, 25vw, 200px);
      background: var(--glass);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--border);
      min-height: 140px;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 8px;
    }

    /* VU Meter */
    .vu-meter {
      background: var(--glass);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
    }

    .vu-meter-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: clamp(14px, 3vw, 16px);
      text-align: center;
    }

    .vu-channels {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .vu-channel {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .vu-channel-label {
      font-size: 10px;
      color: var(--muted);
      font-weight: 500;
    }

    .vu-bar-container {
      width: 20px;
      height: 120px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }

    .vu-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, #4ade80, #fbbf24, #ef4444);
      border-radius: 10px;
      transition: height 0.1s ease;
    }

    .vu-scale {
      position: absolute;
      left: 22px;
      top: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 9px;
      color: var(--muted);
    }

    .vu-scale::before {
      content: "+5";
      position: absolute;
      top: -15px;
      left: 0;
      color: #ef4444;
      font-weight: bold;
    }

    .vu-scale::after {
      content: "0";
      position: absolute;
      top: 0;
      left: 0;
      color: #fbbf24;
      font-weight: bold;
    }

    /* Equalizer - Nowy design */
    .eq-container {
      background: var(--glass);
      border-radius: 12px;
      padding: clamp(16px, 3vw, 20px);
      border: 1px solid var(--border);
    }

    .eq-title {
      font-weight: 600;
      margin-bottom: 16px;
      font-size: clamp(14px, 3vw, 16px);
      text-align: center;
    }

    .eq-sliders {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 4px;
      margin-bottom: 20px;
      padding: 0 8px;
      min-height: 180px;
    }

    @media (max-width: 767px) {
      .eq-sliders {
        gap: 2px;
        padding: 0 4px;
        min-height: 150px;
      }
    }

    .eq-slider {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      flex: 1;
      position: relative;
    }

    .eq-slider input {
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      height: 140px;
      min-height: 120px;
      width: 24px;
      background: linear-gradient(
        to top,
        var(--accent) 0%,
        var(--accent) 50%,
        var(--glass) 50%,
        var(--glass) 100%
      );
      background-size: 100% 200%;
      background-position: 0% 100%;
      border-radius: 12px;
    }

    @media (max-width: 767px) {
      .eq-slider input {
        height: 120px;
        min-height: 100px;
        width: 20px;
      }
    }

    .eq-slider input::-webkit-slider-track {
      background: transparent;
      border: none;
      height: 100%;
      border-radius: 12px;
    }

    .eq-slider input::-webkit-slider-thumb {
      appearance: none;
      width: 28px;
      height: 10px;
      border-radius: 4px;
      background: #000000;
      border: 1px solid var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .eq-slider input::-moz-range-track {
      background: transparent;
      border: none;
      height: 100%;
      border-radius: 12px;
    }

    .eq-slider input::-moz-range-thumb {
      width: 28px;
      height: 10px;
      border-radius: 4px;
      background: #000000;
      border: 1px solid var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .eq-slider-labels {
      position: absolute;
      left: 0;
      right: 0;
      height: 140px;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 0 1px;
    }

    @media (max-width: 767px) {
      .eq-slider-labels {
        height: 120px;
      }
    }

    .eq-slider-label {
      font-size: 8px;
      color: #000000;
      text-align: center;
      opacity: 0.9;
      font-weight: 600;
      text-shadow: 0 0 2px var(--accent);
    }

    .eq-slider-label.zero {
      color: #000000;
      font-weight: 700;
    }

    .eq-slider-freq {
      font-size: clamp(9px, 1.8vw, 11px);
      color: var(--accent);
      font-weight: 600;
      margin-top: 6px;
      text-align: center;
      background: rgba(0,0,0,0.7);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .eq-presets {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 10px;
    }

    .eq-preset-btn {
      padding: 10px 8px;
      font-size: clamp(11px, 2vw, 13px);
      min-height: 38px;
      background: rgba(255,255,255,0.05);
    }

    .eq-preset-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    /* Speed Control */
    .speed-box {
      background: var(--glass);
      border-radius: 12px;
      padding: clamp(16px, 3vw, 20px);
      border: 1px solid var(--border);
    }

    .speed-box label {
      display: block;
      margin-bottom: 12px;
      font-weight: 500;
      font-size: clamp(13px, 2.5vw, 15px);
    }

    /* Playlist */
    .playlist-container {
      background: var(--glass);
      border-radius: 12px;
      padding: clamp(16px, 3vw, 20px);
      border: 1px solid var(--border);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .playlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .playlist-title {
      font-weight: 600;
      font-size: clamp(14px, 3vw, 16px);
    }

    .filelist {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: clamp(200px, 40vh, 400px);
      overflow-y: auto;
      flex: 1;
    }

    .file-item {
      padding: clamp(10px, 2vw, 12px);
      background: var(--panel);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border);
      gap: 12px;
    }

    .file-item.active {
      border-left: 4px solid var(--accent);
      background: rgba(110, 231, 183, 0.05);
    }

    .file-info {
      flex: 1;
      overflow: hidden;
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .file-icon {
      width: clamp(20px, 4vw, 24px);
      height: clamp(20px, 4vw, 24px);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(14px, 3vw, 16px);
    }

    .file-details {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: clamp(12px, 2.5vw, 14px);
      font-weight: 500;
      line-height: 1.3;
    }

    .file-meta {
      font-size: clamp(10px, 2vw, 11px);
      color: var(--muted);
      margin-top: 2px;
      line-height: 1.2;
    }

    .file-controls {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .file-controls .btn {
      padding: 8px;
      min-height: auto;
      font-size: clamp(10px, 2vw, 12px);
      width: 36px;
      height: 36px;
    }

    /* Footer */
    footer {
      margin-top: 20px;
      color: var(--muted);
      font-size: clamp(11px, 2vw, 12px);
      text-align: center;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      line-height: 1.4;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--glass);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* Hide text on very small screens */
    @media (max-width: 380px) {
      .btn-text {
        display: none;
      }
      
      .btn {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="left">
      <div>
        <div class="title">Odtwarzacz MP3</div>
        <div class="subtitle">Wrzuƒá plik audio lub upu≈õƒá go na pole. Lokalnie, bez wysy≈Çania.</div>
      </div>

      <label id="dropzone" class="dropzone" for="file-input">
        <div class="dropzone-icon">üéµ</div>
        <div>Kliknij lub upu≈õƒá plik tutaj</div>
        <div style="font-size:12px; color:var(--muted)">Obs≈Çugiwane formaty: MP3, WAV, OGG, FLAC, AAC, M4A</div>
      </label>
      <input id="file-input" type="file" accept="audio/*" style="display:none" multiple />

      <div class="controls">
        <button id="prevBtn" class="btn" title="Poprzedni">
          <span>‚èÆ</span>
          <span class="btn-text">Poprz.</span>
        </button>
        <button id="playBtn" class="btn accent" title="Odtwarzaj">
          <span>‚ñ∂Ô∏è</span>
          <span class="btn-text">Play</span>
        </button>
        <button id="pauseBtn" class="btn" title="Pauza">
          <span>‚è∏</span>
          <span class="btn-text">Pauza</span>
        </button>
        <button id="stopBtn" class="btn" title="Stop">
          <span>‚èπ</span>
          <span class="btn-text">Stop</span>
        </button>
        <button id="nextBtn" class="btn" title="Nastƒôpny">
          <span>‚è≠</span>
          <span class="btn-text">Nast.</span>
        </button>
        <button id="loopBtn" class="btn" title="Zapƒôtlaj">
          <span>üîÅ</span>
          <span class="btn-text">Loop</span>
        </button>
        <button id="shuffleBtn" class="btn" title="Losuj">
          <span>üîÄ</span>
          <span class="btn-text">Shuffle</span>
        </button>
      </div>

      <div class="progress">
        <input id="seek" type="range" min="0" max="100" value="0">
        <div class="meta">
          <div id="time">00:00 / 00:00</div>
          <div id="filename">Brak pliku</div>
        </div>
      </div>

      <div class="speed-box">
        <label>Prƒôdko≈õƒá odtwarzania: <span id="speedVal">1.0x</span></label>
        <input id="speed" type="range" min="0.5" max="2" step="0.1" value="1">
      </div>

      <div class="eq-container">
        <div class="eq-title">Zaawansowany Equalizer</div>
        
        <div class="eq-presets">
          <button class="btn eq-preset-btn" data-preset="flat">P≈Çaski</button>
          <button class="btn eq-preset-btn" data-preset="bass">Bass Boost</button>
          <button class="btn eq-preset-btn" data-preset="treble">Treble Boost</button>
          <button class="btn eq-preset-btn" data-preset="vshape">V-Shape</button>
          <button class="btn eq-preset-btn" data-preset="loudness">Loudness</button>
          <button class="btn eq-preset-btn" data-preset="reset">Reset</button>
        </div>
        
        <div class="eq-sliders">
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="32" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">32Hz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="64" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">64Hz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="125" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">125Hz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="250" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">250Hz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="500" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">500Hz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="1000" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">1kHz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="2000" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">2kHz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="4000" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">4kHz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="8000" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">8kHz</div>
          </div>
          <div class="eq-slider">
            <input type="range" min="-24" max="24" value="0" data-freq="16000" step="1">
            <div class="eq-slider-labels">
              <div class="eq-slider-label">+24</div>
              <div class="eq-slider-label">+12</div>
              <div class="eq-slider-label zero">0</div>
              <div class="eq-slider-label">-12</div>
              <div class="eq-slider-label">-24</div>
            </div>
            <div class="eq-slider-freq">16kHz</div>
          </div>
        </div>
      </div>

      <footer>
        Last update 19.11.2025
      </footer>
    </div>

    <div class="right">
      <div class="visualizer">
        <canvas id="vis"></canvas>
      </div>

      <div class="vu-meter">
        <div class="vu-meter-title">VU Meter 5.1</div>
        <div class="vu-channels">
          <div class="vu-channel">
            <div class="vu-channel-label">L</div>
            <div class="vu-bar-container">
              <div class="vu-bar" id="vuL"></div>
            </div>
          </div>
          <div class="vu-channel">
            <div class="vu-channel-label">R</div>
            <div class="vu-bar-container">
              <div class="vu-bar" id="vuR"></div>
            </div>
          </div>
          <div class="vu-channel">
            <div class="vu-channel-label">C</div>
            <div class="vu-bar-container">
              <div class="vu-bar" id="vuC"></div>
            </div>
          </div>
          <div class="vu-channel">
            <div class="vu-channel-label">LFE</div>
            <div class="vu-bar-container">
              <div class="vu-bar" id="vuLFE"></div>
            </div>
          </div>
          <div class="vu-channel">
            <div class="vu-channel-label">SL</div>
            <div class="vu-bar-container">
              <div class="vu-bar" id="vuSL"></div>
            </div>
          </div>
          <div class="vu-channel">
            <div class="vu-channel-label">SR</div>
            <div class="vu-bar-container">
              <div class="vu-bar" id="vuSR"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="playlist-container">
        <div class="playlist-header">
          <div class="playlist-title">Lista odtwarzania</div>
          <button id="clearList" class="btn">Wyczy≈õƒá listƒô</button>
        </div>
        <div id="list" class="filelist"></div>
      </div>
    </div>
  </div>

<script>
  // Audio player elements
  const fileInput = document.getElementById('file-input');
  const dropzone = document.getElementById('dropzone');
  const playBtn = document.getElementById('playBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const loopBtn = document.getElementById('loopBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const seek = document.getElementById('seek');
  const time = document.getElementById('time');
  const filename = document.getElementById('filename');
  const speed = document.getElementById('speed');
  const speedVal = document.getElementById('speedVal');
  const listEl = document.getElementById('list');
  const clearBtn = document.getElementById('clearList');
  const eqSliders = document.querySelectorAll('.eq-sliders input');
  const eqPresets = document.querySelectorAll('.eq-preset-btn');

  // VU Meter elements
  const vuBars = {
    L: document.getElementById('vuL'),
    R: document.getElementById('vuR'),
    C: document.getElementById('vuC'),
    LFE: document.getElementById('vuLFE'),
    SL: document.getElementById('vuSL'),
    SR: document.getElementById('vuSR')
  };

  // Audio setup
  let audio = new Audio();
  audio.preload = 'auto';
  let audioURL = null;
  let playlist = [];
  let currentIndex = 0;
  let isPlaying = false;
  
  // Audio context and equalizer setup - JEDNORAZOWA INICJALIZACJA
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const AC = new AudioCtx();
  const analyser = AC.createAnalyser();
  analyser.fftSize = 256;
  
  // Create equalizer nodes - JEDNORAZOWO
  const filters = [];
  const frequencies = [32, 64, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
  
  let sourceNode = null;

  // VU Meter analyzer
  const vuAnalyser = AC.createAnalyser();
  vuAnalyser.fftSize = 2048;
  const vuDataArray = new Uint8Array(vuAnalyser.frequencyBinCount);

  // Inicjalizacja filtr√≥w - JEDNORAZOWO
  function initializeFilters() {
    frequencies.forEach(freq => {
      const filter = AC.createBiquadFilter();
      filter.type = 'peaking';
      filter.frequency.value = freq;
      filter.Q.value = 1;
      filter.gain.value = 0;
      filters.push(filter);
    });
  }

  // Po≈ÇƒÖczenie wƒôz≈Ç√≥w audio - z lepszym zarzƒÖdzaniem
  function connectAudioNodes() {
    // Zawsze roz≈ÇƒÖcz istniejƒÖce po≈ÇƒÖczenia przed tworzeniem nowych
    if (sourceNode) {
      sourceNode.disconnect();
    }
    
    // Utw√≥rz nowe ≈∫r√≥d≈Ço
    sourceNode = AC.createMediaElementSource(audio);
    let currentNode = sourceNode;
    
    // Po≈ÇƒÖcz filtry w serii
    filters.forEach(filter => {
      currentNode.connect(filter);
      currentNode = filter;
    });
    
    // Po≈ÇƒÖcz do analizator√≥w i wyj≈õcia
    currentNode.connect(analyser);
    currentNode.connect(vuAnalyser);
    analyser.connect(AC.destination);
    vuAnalyser.connect(AC.destination);
  }

  // Inicjalizacja przy starcie
  initializeFilters();

  // Equalizer functionality
  eqSliders.forEach((slider, index) => {
    slider.value = 0;
    
    slider.addEventListener('input', () => {
      const gain = parseFloat(slider.value);
      if (filters[index]) {
        filters[index].gain.value = gain;
      }
    });
  });

  // Preset values
  const presetValues = {
    flat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    bass: [16, 12, 8, 4, 0, -2, -4, -6, -4, 0],
    treble: [-6, -4, -2, 0, 2, 6, 10, 14, 16, 18],
    vshape: [12, 8, 4, 0, -2, -4, 0, 6, 10, 14],
    loudness: [8, 6, 4, 2, 0, 2, 4, 6, 8, 10]
  };

  eqPresets.forEach(preset => {
    preset.addEventListener('click', () => {
      const presetType = preset.dataset.preset;
      
      if (presetType === 'reset') {
        eqSliders.forEach((slider, index) => {
          slider.value = 0;
          if (filters[index]) {
            filters[index].gain.value = 0;
          }
        });
      } else if (presetValues[presetType]) {
        presetValues[presetType].forEach((value, index) => {
          if (eqSliders[index] && filters[index]) {
            eqSliders[index].value = value;
            filters[index].gain.value = value;
          }
        });
      }
    });
  });

  // VU Meter update function
  function updateVUMeter() {
    if (!isPlaying) return;
    
    vuAnalyser.getByteFrequencyData(vuDataArray);
    
    const rms = Math.sqrt(vuDataArray.reduce((sum, value) => sum + value * value, 0) / vuDataArray.length);
    const db = 20 * Math.log10(rms / 255);
    
    const normalizedDb = Math.max(-48, Math.min(5, db));
    const height = ((normalizedDb + 48) / 53) * 100;
    
    Object.values(vuBars).forEach((bar, index) => {
      const variation = 0.9 + (Math.random() * 0.2);
      const channelHeight = Math.max(2, height * variation);
      bar.style.height = channelHeight + '%';
    });
    
    requestAnimationFrame(updateVUMeter);
  }

  // Player controls
  shuffleBtn.addEventListener('click', () => {
    shuffleBtn.classList.toggle('active');
  });

  loopBtn.addEventListener('click', () => {
    audio.loop = !audio.loop;
    loopBtn.classList.toggle('active');
  });

  speed.addEventListener('input', () => {
    audio.playbackRate = parseFloat(speed.value);
    speedVal.textContent = speed.value + "x";
  });

  function loadFile(file) {
    // Zatrzymaj aktualne odtwarzanie
    audio.pause();
    isPlaying = false;
    playBtn.textContent = 'Play';
    
    // Zwolnij poprzedni URL
    if (audioURL) {
      URL.revokeObjectURL(audioURL);
    }
    
    // Utw√≥rz nowy URL i ustaw ≈∫r√≥d≈Ço
    audioURL = URL.createObjectURL(file);
    audio.src = audioURL;
    filename.textContent = file.name;

    // Zresetuj event listeners audio
    audio.onloadedmetadata = null;
    audio.ontimeupdate = null;
    audio.onplay = null;
    audio.onpause = null;
    audio.onended = null;
    audio.onerror = null;

    // Ponownie po≈ÇƒÖcz wƒôz≈Çy audio dla nowego ≈∫r√≥d≈Ça
    connectAudioNodes();

    // Ustaw nowe event listeners
    audio.onloadedmetadata = () => {
      if (!isNaN(audio.duration)) {
        seek.max = Math.floor(audio.duration);
        time.textContent = `00:00 / ${fmt(audio.duration)}`;
      }
      updateFileList();
    };

    audio.ontimeupdate = () => {
      if (!isNaN(audio.duration)) {
        seek.value = Math.floor(audio.currentTime);
        time.textContent = `${fmt(audio.currentTime)} / ${fmt(audio.duration)}`;
      }
    };
    
    audio.onplay = () => {
      isPlaying = true;
      playBtn.textContent = 'Pauza';
      if (AC.state === 'suspended') {
        AC.resume();
      }
      updateVUMeter();
    };
    
    audio.onpause = () => {
      isPlaying = false;
      playBtn.textContent = 'Play';
      Object.values(vuBars).forEach(bar => {
        bar.style.height = '0%';
      });
    };
    
    audio.onended = () => {
      isPlaying = false;
      playBtn.textContent = 'Play';
      Object.values(vuBars).forEach(bar => {
        bar.style.height = '0%';
      });
      playNext();
    };

    audio.onerror = (e) => {
      console.error('Audio error:', e);
      isPlaying = false;
      playBtn.textContent = 'Play';
    };
  }

  function fmt(secs) {
    if (isNaN(secs)) return "00:00";
    const m = Math.floor(secs/60).toString().padStart(2,'0');
    const s = Math.floor(secs%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }

  // File type icon mapping
  function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
      'mp3': 'üéµ',
      'wav': 'üéº',
      'ogg': 'üéß',
      'flac': 'üé∂',
      'aac': 'üîä',
      'm4a': 'üìª'
    };
    return {
      icon: icons[ext] || 'üìÑ',
      className: `file-type-${ext} file-type-default`
    };
  }

  function addToList(file) {
    const existingIndex = playlist.findIndex(f => f.name === file.name && f.size === file.size);
    if (existingIndex === -1) {
      playlist.push(file);
      updateFileList();
    }
  }

  function updateFileList() {
    listEl.innerHTML = '';
    playlist.forEach((file, index) => {
      const fileIcon = getFileIcon(file.name);
      const item = document.createElement('div');
      item.className = `file-item ${index === currentIndex ? 'active' : ''}`;
      item.innerHTML = `
        <div class="file-info">
          <div class="file-icon ${fileIcon.className}">${fileIcon.icon}</div>
          <div class="file-details">
            <div class="file-name">${file.name}</div>
            <div class="file-meta">${(file.size / (1024 * 1024)).toFixed(2)} MB ‚Ä¢ ${file.type || 'audio'}</div>
          </div>
        </div>
        <div class="file-controls">
          <button class='btn' data-action="play" title="Odtwarzaj">‚ñ∂Ô∏è</button>
          <button class='btn' data-action="remove" title="Usu≈Ñ">üóëÔ∏è</button>
        </div>
      `;
      
      item.querySelector('[data-action="play"]').onclick = () => playIndex(index);
      item.querySelector('[data-action="remove"]').onclick = (e) => {
        e.stopPropagation();
        removeFromPlaylist(index);
      };
      
      listEl.appendChild(item);
    });
  }

  function removeFromPlaylist(index) {
    if (index === currentIndex) {
      audio.pause();
      audio.currentTime = 0;
      isPlaying = false;
      playBtn.textContent = 'Play';
    }
    
    playlist.splice(index, 1);
    
    if (currentIndex >= index && currentIndex > 0) {
      currentIndex--;
    }
    
    if (playlist.length === 0) {
      if (audioURL) URL.revokeObjectURL(audioURL);
      audio.src = '';
      filename.textContent = 'Brak pliku';
      time.textContent = '00:00 / 00:00';
      seek.value = 0;
      currentIndex = 0;
    } else if (currentIndex < playlist.length) {
      loadFile(playlist[currentIndex]);
    }
    updateFileList();
  }

  function playIndex(i) {
    if (i >= 0 && i < playlist.length) {
      currentIndex = i;
      loadFile(playlist[i]);
      audio.play().catch(e => {
        console.error('Play error:', e);
      });
      updateFileList();
    }
  }

  function playNext() {
    if (playlist.length === 0) return;
    
    if (shuffleBtn.classList.contains('active')) {
      let newIndex;
      do {
        newIndex = Math.floor(Math.random() * playlist.length);
      } while (playlist.length > 1 && newIndex === currentIndex);
      playIndex(newIndex);
    } else {
      const next = (currentIndex + 1) % playlist.length;
      if (next === 0 && !audio.loop) return;
      playIndex(next);
    }
  }

  function playPrev() {
    if (playlist.length === 0) return;
    const prev = (currentIndex - 1 + playlist.length) % playlist.length;
    playIndex(prev);
  }

  // Event listeners
  seek.addEventListener('input', () => {
    if (!isNaN(audio.duration)) {
      audio.currentTime = parseFloat(seek.value);
    }
  });

  playBtn.addEventListener('click', () => {
    if (!audio.src) {
      if (playlist.length > 0) {
        playIndex(currentIndex);
      }
      return;
    }
    
    if (audio.paused) { 
      audio.play().catch(e => {
        console.error('Play error:', e);
      });
    } else { 
      audio.pause(); 
    }
  });

  pauseBtn.addEventListener('click', () => {
    audio.pause();
  });

  stopBtn.addEventListener('click', () => {
    audio.pause(); 
    audio.currentTime = 0; 
    isPlaying = false;
    playBtn.textContent = 'Play';
  });

  prevBtn.addEventListener('click', playPrev);
  nextBtn.addEventListener('click', () => playNext());

  clearBtn.addEventListener('click', () => {
    audio.pause();
    audio.currentTime = 0;
    isPlaying = false;
    playBtn.textContent = 'Play';
    
    listEl.innerHTML = '';
    playlist = [];
    currentIndex = 0;
    if (audioURL) URL.revokeObjectURL(audioURL);
    audio.src = '';
    filename.textContent = 'Brak pliku';
    time.textContent = '00:00 / 00:00';
    seek.value = 0;
  });

  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      if (file.type.startsWith('audio/')) {
        addToList(file);
      }
    });
    if (files.length > 0 && playlist.length === files.length) {
      playIndex(0);
    }
  });

  // Drag & drop
  ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e => { 
    e.preventDefault(); 
    dropzone.classList.add('drag'); 
  }));
  
  ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e => { 
    e.preventDefault(); 
    dropzone.classList.remove('drag'); 
  }));
  
  dropzone.addEventListener('drop', e => {
    const files = Array.from(e.dataTransfer.files);
    files.forEach(file => {
      if (file.type.startsWith('audio/')) {
        addToList(file);
      }
    });
    if (files.length > 0 && playlist.length === files.length) {
      playIndex(0);
    }
  });

  // Visualizer
  const canvas = document.getElementById('vis');
  const ctx = canvas.getContext('2d');
  const buffer = new Uint8Array(analyser.frequencyBinCount);

  function resizeCanvas() {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
  }

  function draw() {
    requestAnimationFrame(draw);
    
    analyser.getByteFrequencyData(buffer);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!isPlaying) return;
    
    const barWidth = canvas.width / buffer.length;
    for(let i = 0; i < buffer.length; i++) {
      const barHeight = (buffer[i] / 255) * canvas.height;
      const hue = 140 - (barHeight / canvas.height) * 40;
      
      ctx.fillStyle = `hsl(${hue}, 70%, 60%)`;
      ctx.fillRect(i * barWidth, canvas.height - barHeight, barWidth - 1, barHeight);
    }
  }

  // Initialize
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();
  draw();
</script>
</body>
</html>